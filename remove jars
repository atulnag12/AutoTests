- name: Remove old JAR files from release if lib exists
  shell: |
    for jar in {{ pre_stage_dir }}/*/{{ folder_name }}/lib/*.jar; do
      jar_name=$(basename $jar)  # Extract the full filename (e.g., library-1.0.0.jar)
      jar_base_name=$(echo $jar_name | sed 's/-[0-9].*\.jar$/.jar/')  # Get the base name (library.jar)
      
      # Check if any version of the same library exists in the release directory
      if ls "{{ release_directory }}/{{ folder_name }}/lib/$jar_base_name" >/dev/null 2>&1; then
        rm -f "{{ release_directory }}/{{ folder_name }}/lib/$jar_base_name"
      fi
    done
  when: lib_dir_status.stat.exists
  register: remove_jars
  failed_when: false









- name: Print release_directory, pre_stage_dir, and container_groups
  debug:
    msg:
      - "release_directory: {{ release_directory }}"
      - "pre_stage_dir: {{ pre_stage_dir }}"
      - "container_groups: {{ container_groups }}"



- name: Remove JAR files from release_directory/lib based on pre_stage_dir
  shell: |
    # Recursively find all JAR files in pre_stage_dir
    find "{{ pre_stage_dir }}" -type f -name "*.jar" | while read -r pre_stage_jar; do
      # Extract the base name without the version (e.g., library.jar from library-1.0.0.jar)
      jar_name=$(basename "$pre_stage_jar")
      jar_base_name=$(echo "$jar_name" | sed -E 's/-[0-9.]+\.jar$/.jar/')

      # Search for matching files in release_directory/lib with the same base name
      release_jar_path="{{ release_directory }}/lib/${jar_base_name}"
      if [ -e "$release_jar_path" ]; then
        echo "Removing JAR: $release_jar_path (matched base name: $jar_base_name)"
        rm -f "$release_jar_path"
      fi
    done
  when: lib_dir_status.stat.exists
  register: remove_jars
  failed_when: false


